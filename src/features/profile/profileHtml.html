<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>DotCode Profile</title>
		{{style}}
	</head>
	<body>
		<header>
			<a id="dotCodeLink">dot</a>
			<button id="accountBtn" class="{{accountBtnInitClass}}">User</button>
			<button id="profile" class="{{profileBtnInitClass}}">My Profile</button>
			<button id="logout" class="{{logoutBtnInitClass}}">Log out</button>
		</header>
		<div class="content-box">
			<div id="accountBox" class="{{accountBoxInitClass}}">
				<span class="name" id="username">User</span>
				<span class="email" id="email"> </span>
				<span class="bio" id="bio"> </span>
				<span class="loginTime" id="loggedInTime"> </span>
				<button id="checkBtn" class="check-btn">see detail</button>
				<div class="devider"></div>
				<div class="logOut-box">
					<span>Do you want to log out temporarily?</span>
					<button id="logoutBtn">Log Out</button>
				</div>
			</div>
			<div id="profileBox" class="{{profileBoxInitClass}}">
				<div class="devider"></div>
				<div class="leave-box">
					<span>Do you want to open your profile in browser?</span>
					<button id="dotCodeRedirect">Open In DotCode</button>
				</div>
				<div class="devider"></div>
			</div>
			<div id="logoutBox" class="{{logoutBoxInitClass}}">
				<div class="logout-devider"></div>
				<div class="logOut-box">
					<span>Do you want to log out temporarily?</span>
					<button id="logoutFromVsBtn">Log Out</button>
				</div>
				<div class="logout-devider"></div>
			</div>
		</div>

		<script>
			const vscode = acquireVsCodeApi();

			const buttons = document.querySelectorAll(".header-btn");

			const accountBox = document.getElementById("accountBox");
			const profileBox = document.getElementById("profileBox");
			const logoutBox = document.getElementById("logoutBox");
			const logoutBtn = document.getElementById("logoutBtn");
			const checkBtn = document.getElementById("checkBtn");
			const dotCodeLink = document.getElementById("dotCodeLink");
			const dotCodeRedirect = document.getElementById("dotCodeRedirect");
			const logoutFromVsBtn = document.getElementById("logoutFromVsBtn");

			const calcDayDifference = (laterDateMs, earlierDateMs) => {
				const diffInMs = laterDateMs - earlierDateMs;
				const minDiff = Math.floor(diffInMs / (60 * 1000));
				const hrDiff = Math.floor(diffInMs / (60 * 60 * 1000));
				const daysDiff = Math.floor(diffInMs / (24 * 60 * 60 * 1000));

				if (daysDiff === 0) {
					if (hrDiff === 0) {
						if (minDiff === 0) {
							return "just now";
						} else if (minDiff === 1) {
							return "a minute ago";
						} else {
							return minDiff + " mins ago";
						}
					} else {
						if (hrDiff === 1) {
							return "an hour ago";
						} else {
							return hrDiff + " hrs ago";
						}
					}
				} else if (daysDiff === 1) {
					return "1 day ago";
				} else if (daysDiff > 0) {
					return daysDiff + " days ago";
				} else {
					return "";
				}
			};

			const lastUpdate = (lastLogin) => {
				const dayDiff = calcDayDifference(Date.now(), lastLogin);
				return `Logged in ${dayDiff}`;
			};

			window.addEventListener("message", (event) => {
				if (event.data.command === "updateUser") {
					const user = event.data.data;
					if (user) {
						document.getElementById("accountBtn").textContent = user.name;
						document.getElementById("username").textContent = user.name;
						document.getElementById("email").textContent = user.email;
						document.getElementById("bio").textContent = user.bio;
						document.getElementById("loggedInTime").textContent = lastUpdate(
							user.loggedInAt
						);
					}
				}
			});

			const updateClassList = (element, addedClass, removedClass) => {
				element.classList.remove(removedClass);
				element.classList.add(addedClass);
			};

			buttons.forEach((button) => {
				button.addEventListener("click", () => {
					buttons.forEach((btn) => btn.classList.remove("active"));
					button.classList.add("active");

					const btnId = button.innerHTML;
					if (btnId === "My Profile") {
						updateClassList(accountBox, "hidden", "shown");
						updateClassList(profileBox, "shown", "hidden");
						updateClassList(logoutBox, "hidden", "shown");
					} else if (btnId === "Log out") {
						updateClassList(accountBox, "hidden", "shown");
						updateClassList(profileBox, "hidden", "shown");
						updateClassList(logoutBox, "shown", "hidden");
					} else {
						updateClassList(accountBox, "shown", "hidden");
						updateClassList(profileBox, "hidden", "shown");
						updateClassList(logoutBox, "hidden", "shown");
					}
				});
			});

			dotCodeLink.addEventListener("click", (event) => {
				event.preventDefault();
				vscode.postMessage({
					command: "redirect",
					data: "http://localhost:5173",
				});
			});

			const logout = (event) => {
				event.preventDefault();
				vscode.postMessage({
					command: "logout",
				});
			};

			logoutBtn.addEventListener("click", logout);
			logoutFromVsBtn.addEventListener("click", logout);

			const gotoDotCode = (event) => {
				event.preventDefault();
				vscode.postMessage({
					command: "detailProfile",
				});
			};

			checkBtn.addEventListener("click", gotoDotCode);
			dotCodeRedirect.addEventListener("click", gotoDotCode);
		</script>
	</body>
</html>
